<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bdqn.huanxun.dao.AgencyMapper">

    <resultMap id="agencyMap" type="Agency">
        <id property="agencyID" column="agencyID"></id>
        <association property="loginUser" resultMap="loginUserMap"></association>
    </resultMap>
    <resultMap id="loginUserMap" type="LoginUser">
        <id property="loginUserID" column="loginUserID"></id>
        <result property="loginName" column="loginName"/>
        <result property="loginPassword" column="loginPassword"/>
    </resultMap>

    <select id="findAgencyById" resultMap="agencyMap" parameterType="Integer">
        select * from `agency` where agencyID = #{agencyId} and visible = 1
    </select>

    <select id="findAll" resultMap="agencyMap">
        SELECT
          a.`agencyID`,
          a.`agencyName`,
          a.`contactName`,
          a.`contactPhone`,
          a.`contactEmail`,
          a.`contactQQ`,
          a.`stuNumber`,
          l.`loginUserID`,
          l.`loginName`
        FROM
          `agency` a,
          `loginuser` l
        WHERE a.`loginUserID` = l.`loginUserID`
          AND a.`visible` = 1
    </select>

    <select id="findAgencyByLikeAgencyName" resultMap="agencyMap">
  SELECT
          a.`agencyID`,
          a.`agencyName`,
          a.`contactName`,
          a.`contactPhone`,
          a.`contactEmail`,
          a.`contactQQ`,
          a.`stuNumber`,
          l.`loginUserID`,
          l.`loginName`
        FROM
          `agency` a,
          `loginuser` l
        WHERE a.`loginUserID` = l.`loginUserID`
          AND a.`visible` = 1
          <if test="agencyName!=null and agencyName!=''">
              AND a.`agencyName` LIKE CONCAT('%',#{agencyName},'%')
          </if>
    </select>

    <select id="queryAgencyById" resultMap="agencyMap" parameterType="Integer">
        SELECT
          a.`agencyID`,
          a.`agencyName`,
          a.`contactName`,
          a.`contactPhone`,
          a.`contactEmail`,
          a.`contactQQ`,
          a.`stuNumber`,
          l.`loginUserID`,
          l.`loginName` ,
          l.`loginPassword`
        FROM
          `agency` a,
          `loginuser` l
        WHERE a.`loginUserID` = l.`loginUserID`
        AND a.`agencyID` = #{agencyId}
          AND a.`visible` = 1
    </select>

    <insert id="addAgency" parameterType="Agency">
        INSERT INTO `agency`
        VALUES (NULL,
                #{agencyName},
                #{loginUser.loginUserID},
                #{contactPhone},
                #{contactEmail},
                #{contactQQ},
                #{stuNumber},
                1,
                #{contactName})
    </insert>

    <update id="updateAgency" parameterType="Agency">
        update `agency`
        set `agencyName` = #{agencyName},
          `loginUserID` = #{loginUser.loginUserID},
          `contactPhone` = #{contactPhone},
          `contactEmail` = #{contactEmail},
          `contactQQ` = #{contactQQ},
          `stuNumber` = #{stuNumber},
          `visible` = 1,
          `contactName` = #{contactName}
        where `agencyID` = #{agencyID};
    </update>
</mapper>